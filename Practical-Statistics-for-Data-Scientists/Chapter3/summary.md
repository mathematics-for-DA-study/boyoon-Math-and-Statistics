# 통계적 실험과 유의성검정



실험설계: 어떤 가설을 확인하거나 기각하기 위한 목표.

통계적 실험의 과정: 가설 수립 - 가설 검정을 위한 실험 설계 - 데이터 수집 - 결론 도출

추론(inference) : 제한된 데이터로 주어진 실험 결과를 더 큰 과정 또는 모집단에 적용하려는 의도



## 3.1 A/B 검정

A/B 검정: 두 가지 처리 방법, 제품, 절차 중 어느 쪽보다 더 우월하다는 것을 입증하기 위해 실험군을 두 그룹으로 나누어 진행하는 실험. 피험자는 무작위로 어느 처리에 할당된다. 처리군 간의 차이는 '다른 처리의 효과'이거나 '어떤 대상이 어떤 처리에 배정될지에 대한 경우'에 의거한다.

* 처리(treatment): 어떤 대상에 주어지는 특별한 환경이나 조건
* 처리군(treatment group): 특정 처리에 노출된 대상들의 집단
* 대조군(control group): 어떤 처리도 하지 않은 대상들의 집단
* 임의화(randomization): 처리를 적용할 대상을 임의로 결정하는 과정
* 대상(subject): 처리를 적용할 개체 대상
* 검정통계(treat statistic): 처리 효과를 측정하기 위한 지표



A/B 검정의 예

두 개의 인터넷 뉴스 제목을 검정하여 더 많은 클릭을 생성하는 쪽을 결정

두 개의 인터넷 광고를 검정하여 어느 것이 더 높은 전환율을 얻을지 판단한다.



**대조군** : 대조군이 없다면 '모든 다른 것이 동일하다'는 보장이 없으며 어떤 차이가 처리 때문인지 확인할 수 없다. 대조군의 경우, 관심 처리를 뺀 나머지는 처리군과 동일한 조건이 적용된다.



데이터 과학의 맥락에서 A/B 검정을 수행하고 재표본추출을 사용하는 것에 대한 논의는 피터 브루스의 Introductory Statistics and Analytics: A Resampling Perspective(Wiley, 2014) 를 참고



## 3.2 가설검정

가설검정(hypothesis test) 혹은 유의성검정(significance test) : 관찰된 효과가 우연에 의한 것인지 여부를 알아내는 것.



* 귀무가설(null hypothesis) : 우연 때문이라는 가설 (영가설)
* 대립가설(alternative hypothesis): 귀무가설과 대조되는 증명하고자하는 가설
* 일원검정(one-way test) : 한 방향으로만 우연히 일어날 확률을 계산하는 가설검정
* 이원검정(two-way tets) : 양방향으로 우연히 일어날 확률을 계산하는 가설검정



가설을 세우는 이유: 연구자가 랜덤하게 일어난 일에 속지 않도록 보호하기 위해.



### 귀무가설

가설검정의 논리: '인간은 실제로 우연히 발생한 일이라도 그것이 흔하지 않다면, 그것에 뭔가 의미가 있을 것이라고 해석하는 경향을 가지고 있다. 그러므로 실험에서 얻은 그룹 간의 차이가 무작위로 얻을 수 있는 합리적인 수준과는 극단적으로 다르다는 증거가 필요하다.' 

귀무가설 : 그룹들이 보이는 결과는 서로 동일하며 그룹 간의 차이는 우연에 의한 결과라는 가설검정시 기본 가정. 귀무가설이 틀렸다는 것을 입증해서 A그룹과 B그룹 간의 차이가 우연이 아니라는 것을 보여주면서 가설검정을 한다.



 ### 대립가설

귀무가설과 대립되는 가설로 귀무가설과 대립가설이 모든 가능성을 설명할 수 있어야 한다.



### 일원/이원 가설 검정

* 일원 가설 검정(한쪽 꼬리 검정) : 방향성을 고려한 대립가설(B는 A보다 낫다). 우연에 의한 극단적인 결과에 대해 한 방향만을 고려하여 p값을 계산
* 이원 가설 검정(양쪽 꼬리 검정) : 대립가설이 양방향(A는 B와 다르며 더 크거나 더 작을 수 있음)이며, 이는 우연에 의한 극단적인 결과가 양쪽에서 나타날 p값을 계산한다는 것을 의미함. 일원가설검정보다 더 보수적인 검정.



## 3.3 재표본추출

* 재표본추출: 랜덤한 변동성을 알아보자는 일반적인 목표를 가지고, 관찰된 데이터의 값에서 표본을 반복적으로 추출하는 것을 의미. 재표본추출에는 부트스트랩과 순열검정이라는 두 가지 유형이 있음.
* 부트스트랩 : 추정의 신뢰성 평가
* 순열검정(permutation test): 두 개 이상의 표본을 함께 결합하여 관측값들을 무작위로 (또는 전부를) 재표본으로 추출하는 과정. 두 개 이상의 그룹과 관련된 가설을 검증하는 데 사용 (임의화검정, 임의순열검정, 정확검정)

### 순열검정

permute : 순서를 바꾼다

순열검정의 과정: 

1. 그룹 A와 그룹 B(여러 그룹)의 결과를 하나로 합친다. 이것은 그룹에 적용된 처리의 결과가 다르지 않다는 귀무가설을 논리적으로 구체화한 것.

2. 결합된 데이터를 잘 섞은 후, 그룹 A와 동일한 크기의 표본을 무작위로 (비복원) 추출한다(당연히 다른 그룹의 일부 데이터를 포함)
3. 나머지 데이터에서 그룹 B와 동일한 크기의 샘플을 무작위로 (비복원) 추출한다.
4. C, D 등의 그룹에 대해서도 동일한 작업을 수행한다. 이제 원본 표본의 크기를 반영하는 재표본을 수집했다.
5. 원래 샘플에 대해 구한 통계량 또는 추정치가 무엇이었든 간에 지금 추출한 재표본에 대해 모두 다시 계산하고 기록한다. 이것으로 한 번의 순열 반복이 진행된다.
6. 앞선 단계들을 R번 반복하여 검정통계량의 순열 분포를 얻는다.

7. 실험을 통해 관찰했던 그룹 간의 차이점과 순열 과정에서 얻은 집합에서의 차이와 비교한다. 관찰된 차이가 순열로 보이는 차이의 집합 안에 잘 들어 있다면, 관찰된 차이가 우연히 일어날 수 있는 범위에 있다는 의미이다. 하지만 관찰된 차이가 대부분의 순열분포 바깥에 있다면 이는 우연에 의한 결과가 아니며 이 그룹 간 차이는 통계적으로 유의미(statistically significant)하다.

## 웹점착성검정

두가지 웹 디자인에 대한 선호에 대한 데이터를 많이 수집하기 어려워, 내부 페이지의 이용을 대리변수로 사용. 측정 지표를 페이지 A와 페이지 B에서의 평균 세션 시간을 비교하는 것으로 정했다.

* 대리변수(proxy variable) : 참된 관심 변수를 대신하는 변수. 관심 변수를 직접 얻을 수 없거나, 측정하는 데 많은 비용이나 시간이 소요될 경우 이를 대체하여 사용

1. A 페이지와 B 페이지의 평균 세션 시간을 비교한다. (평균과 박스플롯으로)

2. 이 차이가 유의한 것인지에 대해 알아보기 위해 순열 검정을 사용한다. 모든 세션 시간을 결합한 다음, 잘 섞은 후 21개의 그룹(A페이지)과 15개의 그룹(B페이지)으로 반복하여 표본을 추출한다. 순열검정을 적용하려면 36개의 세션 시간을 21개(페이지A)와 15개(페이지B)의 그룹에 랜덤하게 할당해야한다.

   ```python
   def permutation_diff(x, nA, nB):
       n = nA + nB
       idx_nB = set(random.sample(range(n), nB))
       idx_nA = set(range(n)) - idx_B
       return x.loc[idx_B].mean() - x.loc[idx_A].mean()
   ```

3. 1000번 시행한 결과로 나온 평균 세션 시간 차이가 실제 관찰된 세션 시간의 차이를 넘어간다. 이 경우 12%의 확률로 발생했는데 이는 페이지 A와 페이지 B 사이의 세션 시간의 차이가 확률분포의 범위 내에 있음을 의미하고, 차이는 통계적으로 유의하지 않다.

   ```python
   permutation_diff = [perm_fun (session_times .Time, nA, nB) for in range (1000)]
   ```

   ```python
   np.mean(permutation_diff > mean_b - mean_a) #0.121
   ```



### 전체 및 부트스트랩 순열검정

위의 랜덤 셔플링 절차인 임의순열검정(random permutation test) 또는 임의화검정(randomized test)라고 하며, 이외에도 전체순열검정(exhaustive permutation test)과 부트스트랩 순열검정(bootstrap permutation test)가 있다.

* 전체순열검정 : 데이터를 무작위로 섞고 나누는 대신 실제로 나눌 수 있는 모든 가능한 조합을 찾는다. 샘플 크기가 작을 때 실용적이며, 셔플링을 많이 반복할수록 임의순열검정 결과는 전체순열검정의 결과와 유사하게 근접한다. 전체순열검정은 영모형이 어떤 유의수준 이상으로 더 유의미하다는 식의 애매한 결론이 아닌 더 정확한 결론을 보장하는 통계적 속성 때문에 정확검정(exact test)이라고도 한다.
* 부트스트랩 순열검정 : 무작위 순열검정을 복원추출로 수행한다. 



### 순열검정 정리

순열검정: 랜덤한 변이가 어떤 역할을 하는지 알아보기 위해 사용되는 휴리스틱한 절차

장점: 해석하고 설명하기 쉬움. 숫자형이나 이진형 데이터 모두에 적용 가능. 샘플 크기가 그룹별로 다를 수 있으며 데이터가 정규분포를 따라야 한다는 가정도 필요없다.



## 3.4 통계적 유의성과 p값

* 통계적으로 유의: 실험 결과가 우연히 벌어질 수 있는 변동성의 바깥에 존재할 때, 이를 통계적으로 유의하다고 한다. 즉 연구 결과가 우연히 일어난 것이 아닌 우연히 일어날 수 없는 극단적인 것이라는 의미이다. 

* p값 : 귀무가설을 구체화한 기회 모델이 주어졌을 때 관측된 결과와 같이 특이하거나 극단적인 결과를 얻을 확률
* 알파: 실제 결과가 통계적으로 의미 있는 것으로 간주되기 위해, 우연에 의한 결과가 능가해야 하는 비정상적인 가능성의 임계 확률
* 제1종 오류: 우연에 의한 효과를 실제 효과라고 잘못 결론 내리는 것
* 제2종 오류: 실제 효과를 우연에 의한 효과라고 잘못 결론 내리는 것



### p값

확률모형이 관측된 결과보다 더 극단적인 결과를 생성하는 빈도. 순열검정으로 얻은 결과 중에서 관찰된 차이와 같거나 더 큰 차이를 보이는 경우의 비율로 p값을 추정할 수 있다. p값이 0.308이라면 우연히 얻은 결과의 30% 정도가 관찰한 것과 비슷한 정도로 예외적인 결과를 얻을 것으로 기대된다. 

P값을 통해 전달하고자 하는 의미: 결과가 우연에서 비롯될 확률.

실제 p값이 나타내는 것: 랜덤 모델이 주어졌을 때 그 결과가 관찰된 결과보다 더 극단적일 확률. p값이 유의미하다고 해서 그게 바로 증거가 되는 것이 아니다.

p값에 대한 6가지 원칙

1. p값은 이 데이터가 특정 모델과 얼마나 상반되는지 나타낼 수 있다.
2. p값은 연구 가설이 사실일 확률이나 데이터가 랜덤하게 생성되었을 확률을 측정하는 것이 아니다.
3. 과학적 결론, 비즈니스나 정책 결정은 p값이 특정 임곗값을 통과하는지 여부를 기준으로 해서는 안된다.
4. 적절한 추론을 위해서는 완전한 보고와 투명성이 요구된다.
5. p값 또는 통계적 유의성은 효과의 크기나 결과의 중요성을 의미하지 않는다.
6. p값 그 자체는 모델이나 가설에 대한 증거를 측정하기 위한 좋은 지표가 아니다.

표본이 클수록, 작고 의미 없는 효과가 우연이라고 볼 수 없을 만큼 충분히 크게 보일 수 있다.

```python
#순열검정법
obs_pct_diff = 100 * (200 / 23739 _ 182 / 22588)
np.mean([diff > obs_pct_diff for diff in permutation_diff])
#정규근사법
survivors = np.array([[200, 23739 - 200],[182,22588-182]])
chi2, p_value, df, _ = stats.chi2_contingency(surviveors)

print(f'p-value for single sided test: {p_value/2:.4f}')
```



### 유의수준

우연히 얻은 (귀무가설) 결과의 5%보다 더 극단적인 결과와 같이 어떤 임곗값(유의수준)을 정해놓는다. '랜덤 모델이 주어졌을 때, 극단적인 결과가 나올 확률은 어느 정도인가?'를 살펴보는 것(확률 문제가 우연히 일어날 확률이 아니라). 즉 랜덤 모델의 적합도에 관해 역으로 추적하는 것이고, 그에 대한 판단은 확률로 나타나지 않는다.



### 제1종과 제2종 오류

* 1종 오류:어떤 사건이 우연히 발생한 것인데 그것이 사실이라고 잘못 판단하는 것. p값이 통계적 유의성에 미치지 못하는 경우 실제 의미는 효과가 입증되지 않았다는 의미다. 보통 1종 오류를 최소화하도록 가설을 설계한다.

* 2종 오류: 어떤 효과가 실제로 있는 것인데, 그것이 우연히 발생한 것이라고 잘못 판단하는 것. 실제로 2종 오류는 표본크기가 너무 작아서 효과를 알아낼 수 없다고 판단하는 것과 같다.
